#!/bin/bash

COLOUR="white"
WIDTH="400"
STYLE="ring"

while getopts ":c:w:s:" opt
do
    case "${opt}" in
        s)
            STYLE=${OPTARG}
            ;;
        c)
            COLOUR=${OPTARG}
            ;;
        w)
            WIDTH=${OPTARG}
            ;;
    esac
done
shift $((OPTIND-1))

if [ -z "$1" ]
then
    echo "Must specify source file"
    exit 1
fi

if [ ! -d "/usr/local/share/tokens/${STYLE}" ]
then
    echo "Style '$STYLE' doesn't exist"
    msg="Try one of: "
    for s in $(find /usr/local/share/tokens/* -type d)
    do
        echo -n "${msg} $(basename ${s})"
        msg=","
    done
    echo "."
    exit 2
fi


frame="/usr/local/share/tokens/${STYLE}/${COLOUR}.png"
if [ ! -f "$frame" ]
then
    echo "Colour of '${COLOUR}' doesn't exist"
    msg="Try one of: "
    for c in /usr/local/share/tokens/${STYLE}/*.png
    do
        c=$(basename $c)
        col=$(echo $c | sed -e 's#.png##g')
        echo -n "${msg} ${col}"
        msg=","
    done
    echo "."
    exit 2
fi

for SRC in $*
do
    if [ ! -f "$SRC" ]
    then
        echo "File '${SRC}' does not exist"
        continue
    fi
    DEST=$(echo ${SRC} | sed -e 's/\.png/\.webp/' -e 's/\.jpe*g/\.webp/')
    if [ -d "Tokens" ]
    then
        DEST="Tokens/${DEST}"
    elif [ -d "tokens" ]
    then
        DEST="tokens/${DEST}"
    fi
    if [ "${SRC}" = "${DEST}" ]
    then
        echo "Source and Destination are both ${SRC}."
        continue
    fi
    echo $SRC "-> $DEST"

    TMP="/tmp/mktokens.png"
    convert -scale 400x400 "${SRC}" /usr/local/share/tokens/mask.png -alpha Off -compose CopyOpacity -composite "${TMP}"
    convert -scale ${WIDTH}x${WIDTH} ${TMP} $frame -composite "${DEST}"
    rm -f "$TMP"
done

exit 0



